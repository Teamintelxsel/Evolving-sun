name: Self-Mutation Evolution

on:
  schedule:
    - cron: '0 2 * * *'  # Run nightly at 2 AM UTC
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: write
  pull-requests: write

jobs:
  evolve:
    runs-on: ubuntu-latest
    timeout-minutes: 480  # 8 hours max
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[all]"
      
      - name: Run KEGG mutation engine
        id: mutate
        run: |
          python scripts/run_evolution.py \
            --generations 10 \
            --pathway-ids ko01100 \
            --target-mutations 10 \
            --output mutations_${{ github.run_number }}.jsonl
        env:
          PYTHONPATH: ${{ github.workspace }}
      
      - name: Analyze mutation results
        id: analyze
        run: |
          python scripts/analyze_mutations.py \
            --input mutations_${{ github.run_number }}.jsonl \
            --threshold 0.005
      
      - name: Create mutation PR
        if: steps.analyze.outputs.has_improvements == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'feat: Apply KEGG-guided mutations (run #${{ github.run_number }})'
          branch: mutation/run-${{ github.run_number }}
          title: 'ðŸ§¬ Mutation PR: Generation ${{ github.run_number }}'
          body: |
            ## ðŸ§¬ Automated Mutation Results
            
            **Run:** #${{ github.run_number }}
            **Timestamp:** ${{ steps.analyze.outputs.timestamp }}
            **Pathway:** ko01100 (Metabolic pathways)
            
            ### Metrics
            - **Total Mutations:** ${{ steps.analyze.outputs.total_mutations }}
            - **Successful:** ${{ steps.analyze.outputs.successful_mutations }}
            - **Fitness Improvement:** ${{ steps.analyze.outputs.fitness_delta }}%
            
            ### Top Mutations Applied
            ${{ steps.analyze.outputs.mutation_summary }}
            
            ---
            *Generated by KEGG Bio-Inspired Mutation Engine*
          labels: |
            automated
            mutation
            evolution
      
      - name: Mint success token (placeholder)
        if: steps.analyze.outputs.has_improvements == 'true'
        run: |
          echo "Token minting for successful mutation"
          echo "Mutation ID: ${{ steps.analyze.outputs.best_mutation_id }}"
          echo "Fitness Delta: ${{ steps.analyze.outputs.fitness_delta }}"
          # In production: integrate with ERC-20 token contract
      
      - name: Upload mutation logs
        uses: actions/upload-artifact@v4
        with:
          name: mutation-logs-${{ github.run_number }}
          path: |
            mutations_${{ github.run_number }}.jsonl
            mutation_analysis.json
          retention-days: 90
      
      - name: Update metrics
        run: |
          python scripts/update_metrics.py \
            --run-number ${{ github.run_number }} \
            --results mutations_${{ github.run_number }}.jsonl
