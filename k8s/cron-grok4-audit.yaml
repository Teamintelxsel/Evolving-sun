# Kubernetes CronJob for Grok-4 Audit
# This CronJob runs automated audits in-cluster for larger jobs
#
# Prerequisites:
# - Kubernetes cluster with appropriate RBAC
# - ConfigMap 'grok4-audit-config' (optional)
# - Secret 'grok4-audit-secrets' (optional, for API keys)
#
# Usage:
#   kubectl apply -f k8s/cron-grok4-audit.yaml
#   kubectl get cronjobs -n evolving-sun
#   kubectl get jobs -n evolving-sun
#
# To run manually:
#   kubectl create job --from=cronjob/grok4-audit grok4-audit-manual -n evolving-sun

apiVersion: v1
kind: Namespace
metadata:
  name: evolving-sun
  labels:
    app.kubernetes.io/name: evolving-sun
    app.kubernetes.io/component: audit
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grok4-audit-config
  namespace: evolving-sun
  labels:
    app.kubernetes.io/name: grok4-audit
    app.kubernetes.io/component: config
data:
  # Audit configuration
  AUDIT_MODE: "audit-only"
  AUDIT_TIMEOUT: "300"
  # Storage configuration
  RESULTS_STORAGE_PATH: "/audit-results"
  # Log level
  LOG_LEVEL: "INFO"
  # Feature flags (safe-by-default)
  BLOCK_ON_VIOLATION: "false"
  ENABLE_EXTERNAL_API: "false"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grok4-audit-results
  namespace: evolving-sun
  labels:
    app.kubernetes.io/name: grok4-audit
    app.kubernetes.io/component: storage
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  # Uncomment and modify for your storage class
  # storageClassName: standard
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: grok4-audit
  namespace: evolving-sun
  labels:
    app.kubernetes.io/name: grok4-audit
    app.kubernetes.io/component: cronjob
    app.kubernetes.io/part-of: evolving-sun
spec:
  # Run every 6 hours by default (adjust as needed)
  schedule: "0 */6 * * *"
  # Keep 3 successful and 1 failed job for debugging
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  # Don't allow concurrent runs to prevent resource contention
  concurrencyPolicy: Forbid
  # Start within 5 minutes or skip
  startingDeadlineSeconds: 300
  jobTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: grok4-audit
        app.kubernetes.io/component: job
    spec:
      # Retry up to 2 times on failure
      backoffLimit: 2
      # Timeout after 30 minutes
      activeDeadlineSeconds: 1800
      template:
        metadata:
          labels:
            app.kubernetes.io/name: grok4-audit
            app.kubernetes.io/component: pod
          annotations:
            # Disable service mesh sidecar for batch jobs
            sidecar.istio.io/inject: "false"
        spec:
          # Use non-root security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
          # Don't restart on failure (let backoffLimit handle retries)
          restartPolicy: Never
          # Service account for RBAC (optional)
          # serviceAccountName: grok4-audit
          
          # Init container to fetch latest audit targets
          initContainers:
            - name: fetch-targets
              image: alpine/git:latest
              command:
                - /bin/sh
                - -c
                - |
                  echo "Fetching latest darwin-results..."
                  # Clone repo or fetch specific artifacts
                  # This is a placeholder - customize based on your setup
                  if [ -n "${GIT_REPO_URL}" ]; then
                    git clone --depth 1 "${GIT_REPO_URL}" /audit-input
                  else
                    echo "No GIT_REPO_URL configured, using existing audit-input"
                    mkdir -p /audit-input
                  fi
              env:
                - name: GIT_REPO_URL
                  valueFrom:
                    configMapKeyRef:
                      name: grok4-audit-config
                      key: GIT_REPO_URL
                      optional: true
              volumeMounts:
                - name: audit-input
                  mountPath: /audit-input
              resources:
                limits:
                  memory: "256Mi"
                  cpu: "200m"
                requests:
                  memory: "128Mi"
                  cpu: "100m"
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: false
                capabilities:
                  drop:
                    - ALL

          containers:
            - name: grok4-audit
              # Use official Python image
              image: python:3.11-slim
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  echo "Starting Grok-4 Audit..."
                  echo "Mode: ${AUDIT_MODE}"
                  
                  # Install minimal dependencies
                  pip install --quiet --no-cache-dir pyyaml requests 2>/dev/null || true
                  
                  # Copy audit script (in production, this would be in the image)
                  if [ ! -f /app/grok4_audit.py ]; then
                    echo "Warning: grok4_audit.py not found in /app, creating placeholder"
                    cat > /tmp/grok4_audit.py << 'SCRIPT'
                  import json
                  import sys
                  from datetime import datetime, timezone
                  
                  result = {
                      "timestamp": datetime.now(timezone.utc).isoformat(),
                      "version": "1.0.0",
                      "mode": "audit-only",
                      "decision": "pass",
                      "safety_flags": {
                          "toxicity": False,
                          "hallucination": False,
                          "api_misuse": False
                      },
                      "audit_summary": "K8s in-cluster audit completed",
                      "files_audited": [],
                      "issues": [],
                      "recommendations": []
                  }
                  
                  output_file = sys.argv[2] if len(sys.argv) > 2 else "/audit-results/result.json"
                  with open(output_file, 'w') as f:
                      json.dump(result, f, indent=2)
                  print(json.dumps(result, indent=2))
                  SCRIPT
                    python /tmp/grok4_audit.py --output-file "${RESULTS_STORAGE_PATH}/audit-$(date +%Y%m%d-%H%M%S).json"
                  else
                    python /app/grok4_audit.py \
                      --input-dir /audit-input \
                      --output-file "${RESULTS_STORAGE_PATH}/audit-$(date +%Y%m%d-%H%M%S).json" \
                      --mode "${AUDIT_MODE}"
                  fi
                  
                  echo "Audit completed successfully"
                  ls -la "${RESULTS_STORAGE_PATH}/"
              env:
                - name: AUDIT_MODE
                  valueFrom:
                    configMapKeyRef:
                      name: grok4-audit-config
                      key: AUDIT_MODE
                      optional: true
                - name: RESULTS_STORAGE_PATH
                  valueFrom:
                    configMapKeyRef:
                      name: grok4-audit-config
                      key: RESULTS_STORAGE_PATH
                      optional: true
                - name: GROK4_AUDIT_ENDPOINT
                  valueFrom:
                    secretKeyRef:
                      name: grok4-audit-secrets
                      key: GROK4_AUDIT_ENDPOINT
                      optional: true
                - name: GROK4_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: grok4-audit-secrets
                      key: GROK4_API_KEY
                      optional: true
              volumeMounts:
                - name: audit-input
                  mountPath: /audit-input
                  readOnly: true
                - name: audit-results
                  mountPath: /audit-results
                - name: app-scripts
                  mountPath: /app
                  readOnly: true
              resources:
                # Adjust based on audit workload size
                limits:
                  memory: "2Gi"
                  cpu: "1000m"
                requests:
                  memory: "512Mi"
                  cpu: "250m"
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: false
                capabilities:
                  drop:
                    - ALL

          volumes:
            - name: audit-input
              emptyDir: {}
            - name: audit-results
              persistentVolumeClaim:
                claimName: grok4-audit-results
            - name: app-scripts
              configMap:
                name: grok4-audit-scripts
                optional: true
                defaultMode: 0755
          
          # Schedule on appropriate nodes
          # nodeSelector:
          #   workload-type: batch
          
          # Tolerations for dedicated audit nodes
          # tolerations:
          #   - key: "audit-workload"
          #     operator: "Equal"
          #     value: "true"
          #     effect: "NoSchedule"
---
# Optional: RBAC for audit job (if accessing K8s resources)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grok4-audit
  namespace: evolving-sun
  labels:
    app.kubernetes.io/name: grok4-audit
    app.kubernetes.io/component: rbac
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: grok4-audit-role
  namespace: evolving-sun
  labels:
    app.kubernetes.io/name: grok4-audit
    app.kubernetes.io/component: rbac
rules:
  # Read-only access to configmaps and secrets for audit config
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]
    resourceNames: ["grok4-audit-secrets"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: grok4-audit-binding
  namespace: evolving-sun
  labels:
    app.kubernetes.io/name: grok4-audit
    app.kubernetes.io/component: rbac
subjects:
  - kind: ServiceAccount
    name: grok4-audit
    namespace: evolving-sun
roleRef:
  kind: Role
  name: grok4-audit-role
  apiGroup: rbac.authorization.k8s.io
